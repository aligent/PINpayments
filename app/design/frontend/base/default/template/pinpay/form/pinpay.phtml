
<?php
/** @var $this Dwyera_Pinpay_Block_Form */

$_form = $this;
$_code = $_form->getMethodCode();
$_method = $_form->getMethod();
$_billingAddress = $this->getBillingAddress();

?>

<ul class="form-list" id="payment_form_<?php echo $_code ?>" style="display:none;">
    <div id="hosted-card-fields">
        <input type="hidden" value="" id="<?php echo $_code ?>_card_token" name="payment[card_token]"/>
    </div>
    <a href="#" class="cvv-what-is-this"><?php echo $this->__("What's a CVC?") ?></a>
</ul>
<div>
    <?php echo $this->getMethod()->getConfigData('message');?>
</div>

<script type="text/javascript">
    //<![CDATA[

    pp = new PinpayHosted(
        {
            token_element: '<?php echo $_code ?>_card_token',
            api_env: '<?php echo $this->getEnvironment() ?>', // or 'live',
            api_key: '<?php echo $this->getPublishableKey()?>', // publishable API key
            form_element_id: 'payment_form_<?php echo $_code ?>', // the parent form
            hosted_fields_element_id: 'hosted-card-fields', // placeholder for card fields
            values: {
                address_line1: '<?php echo $_billingAddress->getStreet1() ?>',
                address_line2: '<?php echo $_billingAddress->getStreet2() ?>',
                address_city: '<?php echo $_billingAddress->getCity() ?>',
                address_state: '<?php echo $_billingAddress->getRegion() ?>',
                address_postcode: '<?php echo $_billingAddress->getPostcode() ?>',
                address_country: '<?php echo $_billingAddress->getCountryModel()->getName() ?>'
            },
            style: [".CardFields--address_line1 { display: none; }",".CardFields--address_line2 { display: none; }",".CardFieldsGroup--city-state-postcode { display: none; }", ".CardFields input { font-size: 18px; }", ".CardFields label { display: none; }", ".CardFields--expiry input { width: 90px; }", ".CardFields--cvc input { width: 90px; }", ".CardFields--expiry, .CardFields--cvc {display: inline-block; }", ".Errors { color: red; font-size: 12px }"]
        }
    );

    var PPPayment = Class.create(Payment, {
        save: function($super, validated) {
            // Ignore this overridden method if the current method isn't PinPay
            if(this.currentMethod != "<?php echo $_code ?>") {
                $super();
                return;
            }
            // only call the the parents save function if the PinPayment form has already been validated
            if(validated) {
                $super();
            } else {
                pp.validatePinPayForm();
            }
        }
    });

    // override the default payment class
    payment = new PPPayment('co-payment-form', '<?php echo $this->getUrl('checkout/onepage/savePayment') ?>');
    //]]>
</script>
