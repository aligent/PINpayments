
<?php
/** @var $this Dwyera_Pinpay_Block_Form */

$_form = $this;
$_code = $_form->getMethodCode();
$_method = $_form->getMethod();
$_billingAddress = $this->getBillingAddress();

?>

<!-- normal form-->
<ul class="form-list" id="payment_form_<?php echo $_code ?>" style="display:none;">

    <div id="hosted-card-fields1">
        <input type="hidden" value="" id="<?php echo $_code ?>_card_token" name="payment[card_token]"/>
    </div>

    <li>
        <div class="buttons-set" id="pinpay-buttons-container">

        <span id="pinpay-please-wait" class="please-wait" style="display: none;">
            <img src="<?php echo $this->getSkinUrl("/images/opc-ajax-loader.gif")?>" alt="Please wait" title="Validating Card..." class="v-middle">Validating Card...        </span>
        </div>
    </li>
</ul>
<div>
    <?php echo $this->getMethod()->getConfigData('message');?>
</div>

<script type="text/javascript">
    //<![CDATA[

    pp = new PinpayHosted(
        {
            token_element: '<?php echo $_code ?>_card_token',
            api_env: '<?php echo $this->getEnvironment() ?>', // or 'live',
            api_key: '<?php echo $this->getPublishableKey()?>', // publishable API key
            form_element_id: 'payment_form_<?php echo $_code ?>', // the parent form
            hosted_fields_element_id: 'hosted-card-fields1' // placeholder for card fields
        }
    );

    var PPPayment = Class.create(Payment, {
        save: function($super, validated) {
            // Ignore this overridden method if the current method isn't PinPay
            if(this.currentMethod != "<?php echo $_code ?>") {
                $super();
                return;
            }
            // only call the the parents save function if the PinPayment form has already been validated
            if(validated) {
                $super();
            } else {
                pp.validatePinPayForm();
            }
        }
    });

    // override the default payment class
    payment = new PPPayment('co-payment-form', '<?php echo $this->getUrl('checkout/onepage/savePayment') ?>');
    //]]>
</script>
